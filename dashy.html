<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORPH-AI-ERA • Dashboard</title>

    <!-- Icons & Plotly -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <style>
        /* This defines the light theme variables. */
        .light-mode {
            --bg: #f8f9fa;
            --panel: #ffffff;
            --panel-2: #f1f3f5;
            --muted: #6c757d;
            --text: #212529;
            --brand: #1E90FF;
            --border: #dee2e6;
            --input-bg: #f1f3f5;
            --danger: #ef4444;
            --success: #28a745;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, .08);
            --toast-bg: #212529;
            --toast-text: #ffffff;
        }
    </style>
    <script>
        // This script runs instantly to apply the saved theme without a flicker.
        (function () {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
            if (theme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>

    <style>
        :root {
            --bg: #0f1115;
            --panel: #1b1f2a;
            --panel-2: #111521;
            --muted: #9aa4b2;
            --text: #e7ecf3;
            --brand: #1E90FF;
            --ok: #28a745;
            --warn: #f59e0b;
            --danger: #ef4444;
            --chip: #0d1320;
            --chip-border: #293245;
            --card-shadow: 0 8px 28px rgba(0, 0, 0, .35);
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, Apple Color Emoji, Segoe UI Emoji;
        }

        /* ===== Shell ===== */
        .wrap {
            display: flex;
            min-height: 100dvh;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            position: sticky;
            top: 0;
            left: 0;
            height: 100vh;
            width: 70px;
            background: var(--panel-2);
            border-right: 1px solid #202533;
            padding: 14px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: width 0.25s ease;
            overflow: hidden;
            z-index: 10;
        }

        .sidebar.expanded {
            width: 220px;
            align-items: flex-start;
        }

        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            /* Changed from width */
            height: 44px;
            border-radius: 12px;
            background: #0c1a33;
            border: 1px solid #1b2a44;
            color: var(--brand);
            font-weight: 700;
            margin-bottom: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .brand span {
            margin-left: 10px;
            font-size: 18px;
            font-weight: 700;
            white-space: nowrap;
            display: none;
        }

        .sidebar.expanded .brand span {
            display: inline;
        }

        .sidebar .spacer {
            flex-grow: 1;
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            flex-shrink: 0;
        }

        .navbtn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
            border: 1px solid #1e2534;
            background: #0e1422;
            color: #a9b3c3;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            /* For anchor tags */
        }

        .navbtn:hover {
            background: #1c2637;
            color: #fff;
        }

        .navbtn span {
            display: none;
        }

        .sidebar.expanded .navbtn span {
            display: inline;
        }

        /* --- NEW AUTH STYLES --- */
        .auth-status {
            display: none;
            /* Hidden when sidebar is collapsed */
            padding: 15px;
            margin-top: 15px;
            border-top: 1px solid #202533;
        }

        .sidebar.expanded .auth-status {
            display: block;
        }

        #userStatus {
            font-size: 13px;
            color: var(--muted);
            margin: 0 0 10px 0;
            white-space: nowrap;
        }

        #authLinks a {
            color: var(--brand);
            text-decoration: none;
            font-size: 14px;
            margin-right: 15px;
            font-weight: 500;
        }

        #authLinks a:hover {
            text-decoration: underline;
        }


        .main {
            flex: 1;
            padding: 24px;
            overflow-x: hidden;
        }

        .title {
            text-align: center;
            margin: 0 0 6px 0;
            font-size: 40px;
            font-weight: 800;
            color: #cfe5ff;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin: 0 0 24px 0
        }

        .metrics {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile: 1 column */
            gap: 18px;
            margin-bottom: 18px;
        }

        .card {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            border: 1px solid #212735;
            border-radius: var(--radius);
            padding: 18px 20px;
        }

        .metric-label {
            color: #9fb1c7;
            font-size: 14px
        }

        .metric-val {
            font-size: 28px;
            font-weight: 800;
            color: #67b2ff;
            margin-top: 8px
        }

        .bar {
            background: linear-gradient(180deg, #121722, #0e1421);
            border: 1px solid #1f2736;
            border-radius: var(--radius);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .group {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .label {
            color: #c8d2e0;
            font-size: 14px
        }

        .select,
        .btn {
            height: 36px;
            border-radius: 10px;
            border: 1px solid #263048;
            background: #12192b;
            color: #e6edf6;
            padding: 0 12px;
            font-size: 14px;
        }

        .select {
            appearance: none;
            padding-right: 26px;
            background-image: linear-gradient(45deg, transparent 50%, #7f8aa0 50%), linear-gradient(135deg, #7f8aa0 50%, transparent 50%);
            background-position: calc(100% - 16px) 50%, calc(100% - 11px) 50%;
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        .btn {
            cursor: pointer;
        }

        .btn.primary {
            background: #1E90FF;
            border-color: #2579d8;
            color: #001527;
            font-weight: 700
        }

        .btn.success {
            background: var(--ok);
            border-color: #1d8a36;
            color: #02140a;
            font-weight: 700
        }

        input[type="file"] {
            display: none
        }

        .file-label {
            border: 1px dashed #2d3a54;
            background: #12192b;
            color: #cfe1ff;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            height: 36px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .panel {
            position: relative
        }

        .panel .head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #cfd8e6;
            font-weight: 700;
        }

        .panel .head .controls {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .plot {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            border: 1px solid #202a3a;
            background: linear-gradient(180deg, #101625, #0c121f);
            overflow: hidden;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobile: 1 column */
            gap: 18px;
            margin-top: 18px;
        }

        .grid .plot {
            height: 340px;
        }

        /* --- RESPONSIVE BREAKPOINTS --- */

        /* Tablets and up */
        @media (min-width: 640px) {
            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Desktops and up */
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Large desktops */
        @media (min-width: 1280px) {
            .metrics {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="wrap">

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="brand" id="toggleSidebar">MAE <span>MORPH-AI-ERA</span></div>
            <nav class="nav">
                <button class="navbtn" data-page="dashboard"><i
                        class="fa-solid fa-gauge-high"></i><span>Dashboard</span></button>

                <a href="analytics.html" class="navbtn"><i class="fa-solid fa-chart-line"></i><span>Analytics</span></a>
                <a href="history.html" class="navbtn"><i class="fa-regular fa-clock"></i><span>History</span></a>
            </nav>
            <div class="spacer"></div>
            <nav class="nav">
                <a href="settings.html" class="navbtn" style="text-decoration: none;"><i
                        class="fa-solid fa-gear"></i><span>Settings</span></a>
                <a href="profile.html" class="navbtn" style="text-decoration: none;"><i
                        class="fa-regular fa-user"></i><span>Profile</span>
                </a>
            </nav>


            <!-- NEW: Auth Status Section -->
            <div class="auth-status">
                <p id="userStatus">Loading status...</p>
                <div id="authLinks"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main" id="main-content">
            <h1 class="title">Welcome to MORPH-AI-ERA</h1>
            <p class="subtitle">Dashboard Overview</p>

            <section class="metrics">
                <div class="card">
                    <div class="metric-label">Total Sales</div>
                    <div id="m-total" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Average Profit</div>
                    <div id="m-avg" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Max Profit</div>
                    <div id="m-max" class="metric-val">$0</div>
                </div>
                <div class="card">
                    <div class="metric-label">Min Profit</div>
                    <div id="m-min" class="metric-val">$0</div>
                </div>
            </section>

            <section class="bar">
                <div class="group">
                    <span class="label">Upload CSV</span>
                    <label for="fileInput" class="file-label"><i class="fa-solid fa-file-arrow-up"></i> Choose
                        File</label>
                    <input id="fileInput" type="file" accept=".csv" />
                </div>
                <div style="flex:1"></div> <!-- Spacer -->
                <div class="group">
                    <button id="btnUpdate" class="btn primary"><i class="fa-solid fa-rotate"></i>&nbsp;Update
                        Chart</button>
                    <button id="btnCalc" class="btn success"><i class="fa-solid fa-calculator"></i>&nbsp;Calculate
                        Metrics</button>
                </div>
            </section>

            <section class="card panel" style="padding:14px;">
                <div class="head">
                    <span>Interactive Chart</span>
                    <div class="controls">
                        <select id="u-type" class="select">
                            <optgroup label="Bar & Column">
                                <option value="bar-h">Bar Chart (Horizontal)</option>
                                <option value="bar">Column Chart (Vertical)</option>
                                <option value="clustered-column">Clustered Column</option>
                                <option value="stacked-bar">Stacked Bar</option>
                                <option value="stacked-column">Stacked Column</option>
                            </optgroup>
                            <optgroup label="Line & Area">
                                <option value="line">Line Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="stacked-area">Stacked Area Chart</option>
                            </optgroup>
                            <optgroup label="Proportional">
                                <option value="pie">Pie Chart</option>
                                <option value="donut">Donut Chart</option>
                                <option value="treemap">Tree Map</option>
                                <option value="sunburst">Sunburst Chart</option>
                            </optgroup>
                            <optgroup label="Relational">
                                <option value="scatter">Scatter Chart</option>
                                <option value="bubble">Bubble Chart</option>
                                <option value="box">Box Plot</option>
                                <option value="violin">Violin Plot</option>
                            </optgroup>
                            <optgroup label="Specialized">
                                <option value="waterfall">Waterfall Chart</option>
                                <option value="funnel">Funnel Chart</option>
                                <option value="gauge">Gauge Chart</option>
                            </optgroup>
                            <optgroup label="Data Display">
                                <option value="heatmap">Matrix (Heatmap)</option>
                            </optgroup>
                            <optgroup label="Geographical">
                                <option value="choropleth">Filled Map (Choropleth)</option>
                            </optgroup>
                            <optgroup label="Hierarchical">
                                <option value="decomposition-tree">Decomposition Tree</option>
                            </optgroup>
                            <optgroup label="Combo">
                                <option value="combo">Combo (Line + Column)</option>
                            </optgroup>
                        </select>
                        <select id="u-metric" class="select"></select>
                    </div>
                </div>
                <div id="main-plot" class="plot"></div>
            </section>

            <!-- 2x2 GRID CHARTS (With Full Controls) -->
            <section class="grid">
                <div class="card panel">
                    <div class="head">
                        <span>Sales Trend</span>
                        <div class="controls">
                            <select id="st-type" class="select">
                                <optgroup label="Common Charts">
                                    <option value="line">Line Chart</option>
                                    <option value="bar">Column Chart</option>
                                    <option value="bar-h">Bar Chart (Horizontal)</option>
                                    <option value="area">Area Chart</option>
                                </optgroup>
                                <optgroup label="Proportional">
                                    <option value="pie">Pie Chart</option>
                                    <option value="donut">Donut Chart</option>
                                </optgroup>
                            </select>
                            <select id="st-metric" class="select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="sales-trend" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head">
                        <span>Profit Trend</span>
                        <div class="controls">
                            <select id="pt-type" class="select">
                                <optgroup label="Common Charts">
                                    <option value="bar">Column Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="bar-h">Bar Chart (Horizontal)</option>
                                    <option value="area">Area Chart</option>
                                </optgroup>
                                <optgroup label="Proportional">
                                    <option value="pie">Pie Chart</option>
                                    <option value="donut">Donut Chart</option>
                                </optgroup>
                            </select>
                            <select id="pt-metric" class="select">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                    </div>
                    <div id="profit-trend" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head">
                        <span>Sales vs Profit (Overlay)</span>
                        <div class="controls">
                            <select id="ovl-type-a" class="select">
                                <option value="bar">Bar (Sales)</option>
                                <option value="line">Line (Sales)</option>
                            </select>
                            <select id="ovl-type-b" class="select">
                                <option value="line">Line (Profit)</option>
                                <option value="bar">Bar (Profit)</option>
                            </select>
                        </div>
                    </div>
                    <div id="overlay-plot" class="plot"></div>
                </div>
                <div class="card panel">
                    <div class="head">
                        <span>Sales vs Profit (Scatter)</span>
                        <div class="controls">
                            <button id="sc-refresh" class="btn"><i class="fa-solid fa-arrows-rotate"></i></button>
                        </div>
                    </div>
                    <div id="scatter-plot" class="plot"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Sidebar Logic ---
        const sidebar = document.getElementById("sidebar");
        const toggleSidebar = document.getElementById("toggleSidebar");
        const mainContent = document.getElementById("main-content");

        toggleSidebar.addEventListener("click", () => {
            sidebar.classList.toggle("expanded");
        });

        document.querySelectorAll(".navbtn[data-page]").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const page = btn.getAttribute("data-page");
                if (page) {
                    mainContent.innerHTML = `<div style="text-align:center; padding-top:100px; font-size: 1.5rem; color: var(--muted);">⚡ ${page.toUpperCase()} page is not available in this demo.</div>`;
                }
            });
        });

        // --- Auth Logic (Simulated) ---
        function checkLoginStatus() {
            // This is a simulated check. In a real application, this would fetch from a server.
            const authLinksDiv = document.getElementById('authLinks');
            const userStatusP = document.getElementById('userStatus');

            // Default to guest state to prevent errors
            const isLoggedIn = false;
            const username = "DemoUser";

            if (isLoggedIn) {
                userStatusP.textContent = `Logged in as: ${username}`;
                authLinksDiv.innerHTML = `<a href="/logout">Log Out</a>`;
            } else {
                userStatusP.textContent = 'Using as: Guest';
                authLinksDiv.innerHTML = `<a href="/login.html">Login</a> <a href="/signup.html">Sign Up</a>`;
            }
        }

        // --- Graphing & Dashboard Logic ---
        const $ = (q) => document.querySelector(q);
        const $$ = (q) => document.querySelectorAll(q);
        let DATASET = [];
        let HEADERS = [];
        let AVAILABLE_METRICS = { numeric: [], categorical: [] };

        function parseCSV(text) {
            const lines = text.trim().split(/\r\n|\n/);
            HEADERS = lines[0].split(',').map(h => h.trim());
            DATASET = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                HEADERS.forEach((header, i) => {
                    const value = values[i] ? values[i].trim() : '';
                    obj[header] = isNaN(value) || value === '' ? value : parseFloat(value);
                });
                return obj;
            });
        }

        function loadSummary() {
            if (DATASET.length === 0) return;
            const sales = DATASET.map(row => row.Sales || 0);
            const profits = DATASET.map(row => row.Profit || 0);
            const totalSales = sales.reduce((a, b) => a + b, 0);
            const avgProfit = profits.length > 0 ? profits.reduce((a, b) => a + b, 0) / profits.length : 0;
            const maxProfit = profits.length > 0 ? Math.max(...profits) : 0;
            const minProfit = profits.length > 0 ? Math.min(...profits) : 0;
            $('#m-total').textContent = '$' + totalSales.toLocaleString();
            $('#m-avg').textContent = '$' + avgProfit.toLocaleString(undefined, { maximumFractionDigits: 2 });
            $('#m-max').textContent = '$' + maxProfit.toLocaleString();
            $('#m-min').textContent = '$' + minProfit.toLocaleString();
            AVAILABLE_METRICS.numeric = HEADERS.filter(h => h && typeof DATASET[0][h] === 'number');
            AVAILABLE_METRICS.categorical = HEADERS.filter(h => h && typeof DATASET[0][h] === 'string');

            const numericOptions = AVAILABLE_METRICS.numeric.map(c => `<option value="${c}">${c}</option>`).join('');
            const categoricalOptions = AVAILABLE_METRICS.categorical.map(c => `<option value="${c}">${c}</option>`).join('');
            const allMetricOptions = `<optgroup label="Categorical">${categoricalOptions}</optgroup><optgroup label="Numeric">${numericOptions}</optgroup>`;

            $('#u-metric').innerHTML = allMetricOptions;
            $('#st-metric').innerHTML = allMetricOptions;
            $('#pt-metric').innerHTML = allMetricOptions;

            if (HEADERS.includes('Sales')) $('#st-metric').value = 'Sales';
            if (HEADERS.includes('Profit')) $('#pt-metric').value = 'Profit';
        }

        function getSeries(metric) {
            if (AVAILABLE_METRICS.categorical.includes(metric)) {
                const aggregation = DATASET.reduce((acc, row) => {
                    const category = row[metric];
                    if (category) {
                        const value = row.Sales || 1;
                        acc[category] = (acc[category] || 0) + value;
                    }
                    return acc;
                }, {});
                return { labels: Object.keys(aggregation), values: Object.values(aggregation) };
            } else {
                const labelCol = AVAILABLE_METRICS.categorical[0] || HEADERS[0];
                return {
                    labels: DATASET.map(row => row[labelCol]),
                    values: DATASET.map(row => row[metric])
                };
            }
        }

        $('#fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                parseCSV(event.target.result);
                refreshAll();
            };
            reader.onerror = () => alert('Error reading file.');
            reader.readAsText(file);
        });

        const plotlyLayout = (title, extra_settings = {}) => ({
            title: { text: title, font: { size: 16, color: '#dbe7ff' } },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { l: 50, r: 25, t: 40, b: 40 },
            xaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            yaxis: { gridcolor: '#1d2738', zeroline: false, tickfont: { color: '#b9c7dd' } },
            showlegend: true,
            legend: { orientation: 'h', y: -0.25, font: { color: '#cbd6ea' } },
            ...extra_settings
        });

        const showPlotMessage = (plotId, message) => {
            $(`#${plotId}`).innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--muted); padding: 20px; text-align: center;">${message}</div>`;
        };

        function generateTracesAndLayout(type, metric) {
            if (!metric) { return { error: 'Please select a metric.' }; }
            let traces = [];
            let layout = plotlyLayout(metric);
            try {
                switch (type) {
                    case 'line': case 'bar': case 'area': {
                        const { labels, values } = getSeries(metric);
                        if (type === 'area') {
                            traces.push({ type: 'scatter', x: labels, y: values, name: metric, mode: 'lines', fill: 'tozeroy' });
                        } else {
                            traces.push({ type: type, x: labels, y: values, name: metric });
                        }
                        break;
                    }
                    case 'stacked-bar':
                    case 'stacked-area': case 'clustered-column': case 'stacked-column': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'This chart requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        if (type === 'stacked-area') {
                            traces.push({ type: 'scatter', x: sales.labels, y: sales.values, name: 'Sales', fill: 'tozeroy', mode: 'none' });
                            traces.push({ type: 'scatter', x: profit.labels, y: profit.values, name: 'Profit', fill: 'tonexty', mode: 'none' });
                        } else {
                            traces.push({ type: 'bar', x: sales.labels, y: sales.values, name: 'Sales' });
                            traces.push({ type: 'bar', x: profit.labels, y: profit.values, name: 'Profit' });
                            layout.barmode = type.includes('stack') ? 'stack' : 'group';
                            if (type === 'stacked-bar') { traces.forEach(t => { t.y = [t.name]; t.x = [t.y.reduce((a, b) => a + b, 0)]; t.orientation = 'h'; }); } // Simplified for example
                        }
                        break;
                    }
                    case 'pie': case 'donut': {
                        const { labels, values } = getSeries(metric);
                        traces.push({ type: 'pie', labels, values, hole: type === 'donut' ? 0.5 : 0, textinfo: 'percent', insidetextorientation: 'radial' });
                        break;
                    }
                    case 'scatter': case 'bubble': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'Requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        const bubbleSizes = type === 'bubble' ? profit.values.map(p => Math.max(Math.abs(p) / 50, 10)) : 12;
                        traces.push({ type: 'scatter', x: sales.values, y: profit.values, mode: 'markers', marker: { size: bubbleSizes, color: profit.values, colorscale: 'Viridis', showscale: true } });
                        layout.xaxis.title = 'Sales'; layout.yaxis.title = 'Profit';
                        break;
                    }
                    case 'box': case 'violin': {
                        const { values } = getSeries(metric);
                        traces.push({ y: values, type: type, name: metric });
                        break;
                    }
                    case 'treemap': case 'sunburst': {
                        const cat1 = AVAILABLE_METRICS.categorical[0];
                        const cat2 = AVAILABLE_METRICS.categorical[1];
                        if (!cat1 || !cat2) { return { error: 'This chart requires at least two categorical columns.' }; }

                        const hierarchy = DATASET.reduce((acc, row) => {
                            const parent = row[cat1]; const child = row[cat2]; const value = row.Sales || 0;
                            if (!acc[parent]) acc[parent] = { children: {}, total: 0 };
                            acc[parent].children[child] = (acc[parent].children[child] || 0) + value;
                            acc[parent].total += value;
                            return acc;
                        }, {});

                        const labels = ['Total']; const parents = [''];
                        const values = [Object.values(hierarchy).reduce((sum, p) => sum + p.total, 0)];

                        for (const parent in hierarchy) {
                            labels.push(parent); parents.push('Total'); values.push(hierarchy[parent].total);
                            for (const child in hierarchy[parent].children) {
                                labels.push(child); parents.push(parent); values.push(hierarchy[parent].children[child]);
                            }
                        }
                        traces.push({ type: type, labels, parents, values, branchvalues: 'total' });
                        break;
                    }
                    case 'heatmap': {
                        const cat1 = AVAILABLE_METRICS.categorical[0];
                        const cat2 = AVAILABLE_METRICS.categorical[1];
                        if (!cat1 || !cat2) { return { error: 'Heatmap requires at least two categorical columns.' }; }
                        const xLabels = [...new Set(DATASET.map(r => r[cat1]))];
                        const yLabels = [...new Set(DATASET.map(r => r[cat2]))];
                        const zValues = yLabels.map(y => xLabels.map(x => {
                            const filtered = DATASET.filter(r => r[cat1] === x && r[cat2] === y);
                            return filtered.reduce((sum, r) => sum + (r[metric] || 0), 0);
                        }));
                        traces.push({ x: xLabels, y: yLabels, z: zValues, type: 'heatmap', colorscale: 'Viridis' });
                        break;
                    }
                    case 'choropleth': { return { error: `Map charts require specific geographical data (e.g., country codes) which was not found.` }; }
                    case 'decomposition-tree': { return { error: `Decomposition Tree is a placeholder for a complex custom visual.` }; }
                    case 'waterfall': case 'funnel': case 'gauge': {
                        return { error: `The "${type}" chart requires specific data structures. This is a placeholder visual.` };
                    }
                    case 'combo': {
                        if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { return { error: 'Combo chart requires "Sales" and "Profit" columns.' }; }
                        const sales = getSeries('Sales'); const profit = getSeries('Profit');
                        traces.push({ type: 'bar', x: sales.labels, y: sales.values, name: 'Sales' });
                        traces.push({ type: 'scatter', mode: 'lines', x: profit.labels, y: profit.values, name: 'Profit', yaxis: 'y2' });
                        layout.yaxis2 = { title: 'Profit', overlaying: 'y', side: 'right', showgrid: false, tickfont: { color: '#ff7f0e' } };
                        break;
                    }
                    default: return { error: `Chart type "${type}" is not implemented.` };
                }
                return { traces, layout };
            } catch (err) {
                console.error(`Failed to generate chart type "${type}":`, err);
                return { error: `Could not draw chart. The data might be in an incompatible format.` };
            }
        }

        function drawChart(plotId, type, metric) {
            const { traces, layout, error } = generateTracesAndLayout(type, metric);
            if (error) {
                if (error.includes("placeholder")) {
                    const staticData = {
                        waterfall: { x: ["Sales", "Consulting", "Maintenance", "Net"], y: [120, 80, -30, 170], measure: ["relative", "relative", "relative", "total"] },
                        funnel: { y: ["Visits", "Downloads", "Pricing", "Invoice", "Finalized"], x: [390, 270, 220, 110, 90] },
                        gauge: { value: 450, title: { text: "Avg. Transaction" }, gauge: { axis: { range: [null, 500] } } }
                    };
                    const chartType = type.split('-')[0];
                    const placeholderTrace = { type: chartType, ...staticData[chartType], mode: chartType === 'gauge' ? 'gauge+number' : undefined };
                    Plotly.react(plotId, [placeholderTrace], plotlyLayout(metric), { responsive: true, displayModeBar: false });
                    showPlotMessage(plotId, error);
                } else {
                    showPlotMessage(plotId, error);
                }
                return;
            }
            if (plotId !== 'main-plot') {
                layout.title.text = ''; // Clear title for grid plots
            }
            Plotly.react(plotId, traces, layout, { responsive: true, displayModeBar: false });
        }

        function drawMain() { drawChart('main-plot', $('#u-type').value, $('#u-metric').value); }
        function drawSalesTrend() { drawChart('sales-trend', $('#st-type').value, $('#st-metric').value); }
        function drawProfitTrend() { drawChart('profit-trend', $('#pt-type').value, $('#pt-metric').value); }

        function drawOverlay() {
            if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { showPlotMessage('overlay-plot', '"Sales" & "Profit" required.'); return; }
            const typeA = $('#ovl-type-a').value.split(' ')[0].toLowerCase();
            const typeB = $('#ovl-type-b').value.split(' ')[0].toLowerCase();
            const { traces: tracesA } = generateTracesAndLayout(typeA, 'Sales');
            const { traces: tracesB } = generateTracesAndLayout(typeB, 'Profit');
            if (tracesA && tracesB) {
                Plotly.react('overlay-plot', [tracesA[0], tracesB[0]], plotlyLayout(''), { responsive: true, displayModeBar: false });
            }
        }
        function drawScatter() {
            if (!HEADERS.includes('Sales') || !HEADERS.includes('Profit')) { showPlotMessage('scatter-plot', '"Sales" & "Profit" required.'); return; }
            const { traces, layout } = generateTracesAndLayout('scatter', 'Sales');
            if (traces) {
                layout.title.text = ''; // Clear title for grid view
                Plotly.react('scatter-plot', traces, layout, { responsive: true, displayModeBar: false });
            }
        }

        function refreshAll() {
            loadSummary();
            drawMain();
            drawSalesTrend();
            drawProfitTrend();
            drawOverlay();
            drawScatter();
        }

        // --- Event Listeners ---
        $('#u-type').addEventListener('change', drawMain);
        $('#u-metric').addEventListener('change', drawMain);
        $('#btnUpdate').addEventListener('click', drawMain);
        $('#btnCalc').addEventListener('click', loadSummary);

        $('#st-type').addEventListener('change', drawSalesTrend);
        $('#st-metric').addEventListener('change', drawSalesTrend);
        $('#pt-type').addEventListener('change', drawProfitTrend);
        $('#pt-metric').addEventListener('change', drawProfitTrend);
        $$('#ovl-type-a, #ovl-type-b').forEach(el => el.addEventListener('change', drawOverlay));
        $('#sc-refresh').addEventListener('click', drawScatter);

        // --- Initial Load ---
        (function () {
            // Check login status first
            checkLoginStatus();

            const defaultCSV = `Date,Region,Product,Sales,Profit
2023-01-15,North,Widgets,1500,300
2023-01-20,North,Gadgets,900,150
2023-02-10,South,Widgets,2200,450
2023-02-18,South,Gizmos,1800,320
2023-03-05,North,Gadgets,1300,220
2023-03-12,West,Widgets,1750,350
2023-04-21,West,Gizmos,2100,410
2023-04-28,East,Gadgets,1100,180`;
            parseCSV(defaultCSV);
            refreshAll();
        })();
    </script>
</body>

</html>